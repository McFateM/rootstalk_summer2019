{{ define "title" }}{{ .Site.Title }}{{ end }}

{{ define "meta" }}
{{- partial "section_meta.html" . -}}
{{- partial "single_meta.html" . -}}
{{- partial "opengraph_meta.html" . -}}
{{ end }}

{{ define "header" }}
{{- partial "section_json_ld.html" . -}}
{{ end }}

{{ define "main" -}}
<main class="main layout__main">
<article class="{{ with .Section }}section-{{ . | urlize }} {{ end }}single-view">

    <div id="articletitle" style="margin-bottom: 3rem">
        <h1 class="title">{{ .Title }}</h1>
    </div>

<div class="content">
{{ .Content }}

<form method="get" action="">
    <input id="search" name="q" type="text" />
    <button type="submit" class="button">Search</button>
    <a href="/search">Clear</a>
</form>

    <br> Results:
    <ul id="results">
    </ul>

  <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
  <script type="text/javascript" src="https://unpkg.com/lunr/lunr.js"></script>
  <script type="text/javascript">
  var lunrIndex,
      $results,
      pagesIndex;

  // Initialize lunrjs using our generated index file
  function initLunr(callback) {
      // First retrieve the index file
      $.getJSON("/js/lunr/PagesIndex.json")
          .done(function(index) {
              pagesIndex = index;
              console.log("index:", pagesIndex);

              // Set up lunrjs by declaring the fields we use
              // Also provide their boost level for the ranking
            lunrIndex = lunr(function() {
                  this.field("title", {
                      boost: 10
                  });
                  this.field("tags", {
                      boost: 5
                  });
                  this.field("content");

                  // ref is the result item identifier (I chose the page URL)
                  this.ref("href");

                  // Feed lunr with each file and let lunr actually index them
                  pagesIndex.forEach(function(page) {
                    if (page != null) {
                        this.add(page);
                    }
                  }, this);
              });
              console.log("index built!!!");
              callback();

          })

          .fail(function(jqxhr, textStatus, error) {
              var err = textStatus + ", " + error;
              console.error("Error getting Hugo index file:", err);
          });
  }

  // Nothing crazy here, just hook up a listener on the input field
  function initUI() {
    const query = new URLSearchParams(window.location.search);
    const searchString = query.get('q');
      $results = $("#results");
    //   $("#search").keyup(function() {
    //       $results.empty();

    //       // Only trigger a search when 2 chars. at least have been provided
    //       var query = $(this).val();
          console.log(searchString);

          if (searchString.length < 2) {
              return;
          }

          var results = search(searchString);
          console.log("searched lunr index.");

          renderResults(results);
      
  }

  /**
   * Trigger a search in lunr and transform the result
   *
   * @param  {String} query
   * @return {Array}  results
   */
  function search(query) {
      // Find the item in our index corresponding to the lunr one to have more info
      // Lunr result: 
      //  {ref: "/section/page1", score: 0.2725657778206127}
      // Our result:
      //  {title:"Page1", href:"/section/page1", ...}
      console.log("searching...");
      return lunrIndex.search(query).map(function(result) {
              return pagesIndex.filter(function(page) {
                  return page.href === result.ref;
              })[0];
          });
  }

  /**
   * Display the 10 first results
   *
   * @param  {Array} results to display
   */
  function renderResults(results) {
      if (!results.length) {
          return;
      }

      console.log("result(s) matched!");
      // Only show the ten first results
      results.slice(0, 10).forEach(function(result) {
          var $result = $("<li>");
          $result.append($("<a>", {
              href: result.href,
              text: "Â» " + result.title
          }));
          $results.append($result);
      });
  }

  $(document).ready(function() {

      initLunr(initUI);

  });
  </script>


</div>
</article>
</main>

{{ end }}